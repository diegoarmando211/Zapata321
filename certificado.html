<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LABMETAL SAC - Generador de Certificados</title>
    <meta name="description" content="Sistema de generación de certificados de análisis para LABMETAL SAC">
    <link rel="stylesheet" href="./certificado-style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase Auth para seguridad -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC8ZYyutzFmGzO-O9KYIANQZvl2BhQvB20",
            authDomain: "certificados-a7d6f.firebaseapp.com",
            projectId: "certificados-a7d6f",
            storageBucket: "certificados-a7d6f.firebasestorage.app",
            messagingSenderId: "414462338444",
            appId: "1:414462338444:web:869e510428b2140d7762a9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Verificar autenticación
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                // Usuario no autenticado, redirigir al login
                window.location.href = 'index.html';
            }
        });

        // Función para cerrar sesión
        window.cerrarSesion = function() {
            signOut(auth).then(() => {
                window.location.href = 'index.html';
            });
        };
    </script>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <i class="fas fa-microscope"></i>
                    <h1>LABMETAL SAC</h1>
                    <p>Sistema de Certificados de Análisis</p>
                </div>
                <button onclick="cerrarSesion()" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </button>
            </div>
        </header>

        <main class="main-content">
            <!-- Panel de Control -->
            <div class="control-panel">
                <div class="panel-header">
                    <h2><i class="fas fa-file-alt"></i> Generar Certificado</h2>
                </div>

                <!-- Estado del sistema -->
                <div id="system-status" class="status-info">
                    <i class="fas fa-check-circle"></i> Sistema listo
                </div>

                <!-- Formulario de datos -->
                <form id="certificateForm" class="certificate-form">
                    <!-- Información del Cliente -->
                    <div class="form-section">
                        <h3><i class="fas fa-user"></i> Información del Cliente</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cliente">Cliente:</label>
                                <input type="text" id="cliente" name="cliente" placeholder="Ej: JESÚS OTINIANO" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="referencia">Referencia:</label>
                                <input type="text" id="referencia" name="referencia" placeholder="Ej: A - 03-10-2025">
                            </div>
                            <div class="form-group">
                                <label for="solicitud">Solicitud de Análisis:</label>
                                <input type="text" id="solicitud" name="solicitud" placeholder="Ej: Duplicado - Au">
                            </div>
                        </div>
                    </div>

                    <!-- Información de la Muestra -->
                    <div class="form-section">
                        <h3><i class="fas fa-vial"></i> Información de la Muestra</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="material">Material:</label>
                                <select id="material" name="material">
                                    <option value="">Seleccionar material...</option>
                                    <option value="Mineral Óxido">Mineral Óxido</option>
                                    <option value="Mineral Sulfurado">Mineral Sulfurado</option>
                                    <option value="Concentrado">Concentrado</option>
                                    <option value="Relaves">Relaves</option>
                                    <option value="Suelo">Suelo</option>
                                    <option value="Roca">Roca</option>
                                    <option value="Agua">Agua</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="codigo">Código:</label>
                                <input type="text" id="codigo" name="codigo" placeholder="Ej: MO" maxlength="5">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="condiciones">Condiciones y Características:</label>
                                <input type="text" id="condiciones" name="condiciones" placeholder="Ej: Muestra en bolsa con precinto">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="fechaRecepcion">Fecha de Recepción:</label>
                                <input type="date" id="fechaRecepcion" name="fechaRecepcion">
                            </div>
                            <div class="form-group">
                                <label for="humedad">% H₂O:</label>
                                <input type="text" id="humedad" name="humedad" placeholder="—">
                            </div>
                        </div>
                    </div>

                    <!-- Información del Laboratorio -->
                    <div class="form-section">
                        <h3><i class="fas fa-flask"></i> Datos del Laboratorio</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="numeroLab">N° LAB:</label>
                                <input type="text" id="numeroLab" name="numeroLab" placeholder="Ej: MO">
                            </div>
                            <div class="form-group">
                                <label for="descripcion">Descripción:</label>
                                <input type="text" id="descripcion" name="descripcion" placeholder="Ej: ELIO">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="resultadoMalla150Mas">MALLA + 150 Au (Gr/Tm):</label>
                                <input type="number" id="resultadoMalla150Mas" name="resultadoMalla150Mas" step="0.001" placeholder="Ej: 2.011">
                            </div>
                            <div class="form-group">
                                <label for="resultadoMalla150Menos">MALLA - 150 Au (Gr/Tm):</label>
                                <input type="number" id="resultadoMalla150Menos" name="resultadoMalla150Menos" step="0.001" placeholder="Ej: 8.324">
                            </div>
                        </div>
                    </div>

                    <!-- Resultados -->
                    <div class="form-section">
                        <h3><i class="fas fa-chart-line"></i> Resultados</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="resultadoGrTm">Resultado Au (Gr/Tm):</label>
                                <input type="number" id="resultadoGrTm" name="resultadoGrTm" step="0.001" placeholder="Ej: 3.800">
                            </div>
                            <div class="form-group">
                                <label for="resultadoOzTc">Resultado Au (Oz/Tc):</label>
                                <input type="number" id="resultadoOzTc" name="resultadoOzTc" step="0.001" placeholder="Ej: 0.111">
                            </div>
                        </div>
                    </div>

                    <!-- Información Final -->
                    <div class="form-section">
                        <h3><i class="fas fa-calendar-check"></i> Información Final</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fechaFinal">Fecha Final:</label>
                                <input type="date" id="fechaFinal" name="fechaFinal">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="observaciones">Observaciones:</label>
                                <textarea id="observaciones" name="observaciones" rows="3" placeholder="Observaciones adicionales..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Botones de Acción -->
                    <div class="form-actions">
                        <button type="button" onclick="generarCertificadoPDF()" class="btn btn-primary">
                            <i class="fas fa-file-pdf"></i> Generar Certificado PDF
                        </button>
                        <button type="button" onclick="limpiarFormulario()" class="btn btn-secondary">
                            <i class="fas fa-broom"></i> Limpiar Formulario
                        </button>
                        <button type="button" onclick="cargarDatosEjemplo()" class="btn btn-info">
                            <i class="fas fa-magic"></i> Cargar Ejemplo
                        </button>
                    </div>
                    
                    <!-- Botones de Diagnóstico -->
                    <div class="form-actions" style="border-top: 1px solid #e9ecef; margin-top: 0; padding-top: 1rem;">
                        <button type="button" onclick="verificarJsPDF()" class="btn btn-outline" style="flex: 1;">
                            <i class="fas fa-stethoscope"></i> Verificar jsPDF
                        </button>
                        <button type="button" onclick="forzarRecargaJsPDF()" class="btn btn-outline" style="flex: 1;">
                            <i class="fas fa-sync-alt"></i> Recargar jsPDF
                        </button>
                        <button type="button" onclick="usarAlternativaPDF()" class="btn btn-outline" style="flex: 1;">
                            <i class="fas fa-file-alt"></i> Generar TXT
                        </button>
                    </div>
                </form>
            </div>

            <!-- Vista Previa -->
            <div class="preview-panel">
                <div class="panel-header">
                    <h2><i class="fas fa-eye"></i> Vista Previa</h2>
                </div>
                <div class="preview-content">
                    <div id="preview-info" class="preview-info">
                        <p>Complete el formulario para ver la vista previa del certificado</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Sistema simple y efectivo de carga de jsPDF
        let jsPDFLoaded = false;
        let loadAttempts = 0;
        const maxAttempts = 5;
        
        // CDNs de respaldo con diferentes versiones para mayor compatibilidad
        const jsPDFSources = [
            'https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js',
            'https://cdn.jsdelivr.net/npm/jspdf@latest/dist/jspdf.umd.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
            'https://unpkg.com/jspdf@2.4.0/dist/jspdf.umd.min.js'
        ];
        
        function cargarJsPDF(sourceIndex = 0) {
            if (sourceIndex >= jsPDFSources.length) {
                console.error('❌ No se pudo cargar jsPDF desde ninguna fuente');
                actualizarEstadoSistema('error', 'Error: jsPDF no disponible - Usar método de respaldo');
                return;
            }
            
            loadAttempts++;
            console.log(`🔄 Intento ${loadAttempts}: Cargando jsPDF desde ${jsPDFSources[sourceIndex]}`);
            
            const script = document.createElement('script');
            script.src = jsPDFSources[sourceIndex];
            
            script.onload = () => {
                // Esperar un poco para que jsPDF se inicialice
                setTimeout(() => {
                    let jsPDFDisponible = false;
                    
                    // Verificar múltiples formas en que jsPDF puede estar disponible
                    if (typeof window.jsPDF !== 'undefined') {
                        jsPDFDisponible = true;
                        console.log('✅ jsPDF encontrado en window.jsPDF');
                    } else if (typeof window.jspdf !== 'undefined') {
                        window.jsPDF = window.jspdf;
                        jsPDFDisponible = true;
                        console.log('✅ jsPDF encontrado en window.jspdf y normalizado');
                    } else if (typeof jsPDF !== 'undefined') {
                        window.jsPDF = { jsPDF: jsPDF };
                        jsPDFDisponible = true;
                        console.log('✅ jsPDF encontrado globalmente y normalizado');
                    }
                    
                    // Verificar que realmente funciona
                    if (jsPDFDisponible) {
                        try {
                            const { jsPDF: PDFConstructor } = window.jsPDF;
                            if (typeof PDFConstructor === 'function') {
                                const testDoc = new PDFConstructor();
                                if (testDoc && typeof testDoc.save === 'function') {
                                    jsPDFLoaded = true;
                                    console.log(`✅ jsPDF verificado y funcional desde: ${jsPDFSources[sourceIndex]}`);
                                    actualizarEstadoSistema('success', 'Sistema listo - jsPDF funcional');
                                    return;
                                }
                            }
                        } catch (error) {
                            console.warn(`⚠️ jsPDF cargado pero no funcional: ${error.message}`);
                        }
                    }
                    
                    console.warn(`⚠️ Script cargado pero jsPDF no funcional desde: ${jsPDFSources[sourceIndex]}`);
                    setTimeout(() => cargarJsPDF(sourceIndex + 1), 500);
                }, 1000);
            };
            
            script.onerror = () => {
                console.warn(`❌ Error cargando desde: ${jsPDFSources[sourceIndex]}`);
                setTimeout(() => cargarJsPDF(sourceIndex + 1), 500);
            };
            
            // Timeout de 5 segundos por intento
            setTimeout(() => {
                if (!jsPDFLoaded && script.parentNode) {
                    console.warn(`⏱️ Timeout cargando desde: ${jsPDFSources[sourceIndex]}`);
                    script.remove();
                    cargarJsPDF(sourceIndex + 1);
                }
            }, 5000);
            
            document.head.appendChild(script);
        }
        
        function actualizarEstadoSistema(tipo, mensaje) {
            const status = document.getElementById('system-status');
            if (!status) return;
            
            const iconos = {
                success: 'fas fa-check-circle',
                warning: 'fas fa-exclamation-triangle',
                error: 'fas fa-times-circle',
                loading: 'fas fa-spinner fa-spin'
            };
            
            status.innerHTML = `<i class="${iconos[tipo] || iconos.loading}"></i> ${mensaje}`;
            status.className = `status-info ${tipo}`;
        }
        
        // Función para verificar y recargar jsPDF si es necesario
        window.verificarJsPDF = function() {
            if (typeof window.jsPDF !== 'undefined') {
                actualizarEstadoSistema('success', 'jsPDF está disponible y funcionando');
                return true;
            } else {
                actualizarEstadoSistema('warning', 'Reintentando cargar jsPDF...');
                jsPDFLoaded = false;
                loadAttempts = 0;
                
                // Limpiar scripts existentes
                const scriptsExistentes = document.querySelectorAll('script[src*="jspdf"]');
                scriptsExistentes.forEach(script => script.remove());
                
                cargarJsPDF(0);
                return false;
            }
        };
        
        // Función alternativa si jsPDF falla completamente
        window.usarAlternativaPDF = function() {
            actualizarEstadoSistema('warning', 'Usando método alternativo - Sin dependencias externas');
            
            // Llamar directamente al generador de texto
            if (typeof window.generarCertificadoTexto === 'function') {
                window.generarCertificadoTexto();
            } else {
                alert('Por favor, usa el botón "Generar PDF" e selecciona la opción de generar archivo de texto.');
            }
        };
        
        // Configuración inicial
        window.addEventListener('load', function() {
            // Establecer fechas por defecto
            const hoy = new Date();
            document.getElementById('fechaRecepcion').value = hoy.toISOString().split('T')[0];
            document.getElementById('fechaFinal').value = hoy.toISOString().split('T')[0];
            
            // Auto-generar referencia
            const dia = hoy.getDate().toString().padStart(2, '0');
            const mes = (hoy.getMonth() + 1).toString().padStart(2, '0');
            const año = hoy.getFullYear();
            document.getElementById('referencia').value = `A - ${dia}-${mes}-${año}`;
            
            // Inicializar estado
            actualizarEstadoSistema('loading', 'Cargando jsPDF...');
            
            // Iniciar carga de jsPDF
            cargarJsPDF(0);
            
            // Verificación adicional después de 3 segundos
            setTimeout(() => {
                if (!jsPDFLoaded) {
                    verificarJsPDF();
                }
            }, 3000);
        });
    </script>
    <script src="./certificado-script.js"></script>
</body>
</html>